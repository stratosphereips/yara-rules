rule linux_trojan_anchorTrickbot {
  meta:
    author      = "@_lubiedo"
    description = "Linux/Anchor.Trickbot with embedded PE"
    reference0  = "https://www.bleepingcomputer.com/news/security/linux-warning-trickbot-malware-is-now-infecting-your-systems/"
    hash0       = "4655b4b44f6962e4f9641a52c24373390766c50b62fcc222e40511c0f1ed91d2"
    hash1       = "c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc"
    date        = "2020-07-31"
  strings:
    // strs
    $s0   = "/tmp/anchor.log"
    $s1   = "--debuglevel="
    $s2   = "/proc/%s/cmdline"
    $s3   = "0123456789CONNECT_ONLY is required!"

    // ip retrieval
    $ip0	= "http://checkip.amazonaws.com"
		$ip1	= "http://ipecho.net/plain"
		$ip2	= "http://ipinfo.io/ip"
		$ip3	= "http://api.ipify.org"
		$ip4	= "http://icanhazip.com"
		$ip5	= "http://myexternalip.com/raw"
		$ip6	= "http://wtfismyip.com/text"
		$ip7	= "http://ip.anysrc.net/plain/clientip"
    $ip8  = "test my ip"

    // embedded PE
    $pe0  = "This program cannot be run in DOS mode." fullword
    $pe1  = "kernel32.dll" nocase
    $pe2  = "GetCommandLineA"
		$pe3	= "/C timeout 10 && %ssc.exe delete %S"
		$pe4	= "del %S"

  condition:
      uint32(0) == 0x464c457f and filesize < 1MB
        and 3 of ($ip*) and all of ($pe*, $s*)
}
